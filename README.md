# תיקוני מערכת ההתראות - גרסה 2.2

## סיכום הבעיות שתוקנו

### 1. התראות קופצות גם כשעובדים על משימה
**בעיה:** מנהל ההתראות לא זיהה שיש טיימר פעיל ושלח התראות על משימות אחרות.

**פתרון:** 
- הוספת פונקציה `getActiveTimerInfo()` שמזהה גם טיימר רץ וגם טיימר מושהה
- כשיש טיימר מושהה - לא שולחים התראות על משימות אחרות
- כשיש טיימר רץ - שולחים רק התראות על המשימה הפעילה (כמו "נשארו 5 דקות")

### 2. שעות עבודה קשיחות בקוד
**בעיה:** שעות העבודה היו קשיחות (08:30-16:15) ולא נקראו מההגדרות.

**פתרון:**
- הוספת פונקציה `getWorkHoursSettings()` שקוראת הגדרות מ-localStorage
- הממשק תומך עכשיו בדקות (לא רק שעות שלמות)
- שמירה כפולה: גם בפורמט הישן וגם בפורמט שמנהל ההתראות מחפש

### 3. זמן לא נשמר כשעוצרים משימה
**בעיה:** ה-localStorage נוקה לפני השמירה, כך שהזמן לא נשמר.

**פתרון:**
- שינוי סדר הפעולות ב-`stopAndSave` - קודם שומרים, אחר כך מנקים

### 4. התראה "אין טיימר" קופצת מיד
**בעיה:** ברגע שעוצרים טיימר, ההתראה קפצה מיידית.

**פתרון:**
- הוספת **grace period** של 2 דקות
- כשטיימר נעצר, מתחיל ספירה חדשה של 2 דקות לפני התראה

### 5. פופאפ משימה באיחור לא עובד
**בעיה:** הפופאפ לא הגיב ללחיצות ולא אפשר לבחור אפשרויות.

**פתרון:**
- קומפוננטה חדשה `OverdueTaskPopup` עם כל האפשרויות:
  - **התחל לעבוד** - מתחיל את הטיימר על המשימה
  - **דחה ב-5/10/15/30 דקות** - מעדכן את זמן המשימה
  - **הוסף זמן למשימה** - מוסיף 15/30/45/60 דקות
  - **העבר למחר** - מעביר את המשימה ליום הבא
  - **בוצע** - מסמן את המשימה כהושלמה

---

## קבצים שהשתנו

### 1. `src/components/Notifications/UnifiedNotificationManager.jsx`
- פונקציה חדשה: `getActiveTimerInfo()` - מזהה טיימר רץ/מושהה
- פונקציה חדשה: `getWorkHoursSettings()` - קוראת הגדרות שעות עבודה
- לוגיקה משופרת: התראות רק כשאין טיימר כלל
- Grace period של 2 דקות
- שימוש בפופאפ החדש למשימות באיחור

### 2. `src/components/Notifications/OverdueTaskPopup.jsx` (חדש!)
- פופאפ מותאם למשימות באיחור
- אפשרויות: התחל, דחה, הוסף זמן, העבר למחר, בוצע
- עיצוב דומה לפופאפ של מנהלת המשרד
- כל הפעולות מעדכנות את המשימה באמת

### 3. `src/components/Tasks/TaskTimerWithInterruptions.jsx`
- תיקון שמירת ID (לא 'active')
- הטיימר לא נמחק כשמושהה
- שמירה לפני ניקוי localStorage

### 4. `src/pages/Settings.jsx`
- הגדרות שעות עבודה עם דקות (לא רק שעות שלמות)
- שמירה כפולה לתאימות עם מנהל ההתראות
- תצוגה משופרת של השעות שנבחרו

---

## התקנה

1. גבי את הקבצים הקיימים
2. העתיקי את הקבצים החדשים למקומם:
   - `src/components/Notifications/UnifiedNotificationManager.jsx`
   - `src/components/Notifications/OverdueTaskPopup.jsx` (חדש!)
   - `src/components/Tasks/TaskTimerWithInterruptions.jsx`
   - `src/pages/Settings.jsx`
3. רענני את האפליקציה

---

## בדיקות מומלצות

1. **התחלת טיימר** - וודאי שההתראות לא קופצות על משימות אחרות
2. **השהיית טיימר** - וודאי שלא מקבלת התראות "אין טיימר פעיל" (רק אחרי X דקות - התראת "משימה מושהית")
3. **עצירת טיימר** - וודאי שהזמן נשמר נכון
4. **הגדרות שעות עבודה** - בדקי שאפשר לבחור גם 8:45 או 16:20
5. **פופאפ משימה באיחור** - בדקי שכל הכפתורים עובדים:
   - "התחל לעבוד" מתחיל את הטיימר
   - "דחה" מעדכן את זמן המשימה
   - "הוסף זמן" מעדכן את משך המשימה
   - "העבר למחר" מעביר את המשימה
